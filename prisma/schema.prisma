generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                    String         @id @default(uuid())
  username              String         @unique
  email                 String         @unique
  passwordHash          String
  firstname             String?
  lastname              String?
  bio                   String?
  avatar                String?
  isPrivate             Boolean        @default(false)
  isVerified            Boolean        @default(false) // برای تأیید ایمیل
  posts                 Post[]
  likes                 Like[]
  bookmarks             Bookmark[]
  followers             Follow[]       @relation("Follower")
  following             Follow[]       @relation("Following")
  followRequestsSent    FollowRequest[] @relation("Requester")
  followRequestsReceived FollowRequest[] @relation("Target")
  closeFriendsSent      CloseFriend[]  @relation("UserCloseFriends")
  closeFriendsReceived  CloseFriend[]  @relation("FriendCloseFriends")
  blockedUsers          Block[]        @relation("Blocker")
  blockedBy             Block[]        @relation("Blocked")
  notifications         Notification[] @relation
  actions               Notification[] @relation("Actor")
  mentions              Mention[]
  comments              Comment[]
  commentLikes          CommentLike[]
  verificationTokens    VerificationToken[]
  postCount             Int            @default(0)
  followerCount         Int            @default(0)
  followingCount        Int            @default(0)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  PasswordResetToken PasswordResetToken[]
}

model PasswordResetToken { 
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Post {
  id                 String       @id @default(uuid())
  caption            String?
  userId             String
  user               User         @relation(fields: [userId], references: [id])
  images             PostImage[]
  likes              Like[]
  bookmarks          Bookmark[]
  mentions           Mention[]
  hashtags           PostHashtag[]
  comments           Comment[]
  isCloseFriendsOnly Boolean      @default(false)
  likeCount          Int          @default(0)
  bookmarkCount      Int          @default(0)
  commentCount       Int          @default(0)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  Notification       Notification[]
}

model PostImage {
  id     String @id @default(uuid())
  url    String
  postId String
  post   Post   @relation(fields: [postId], references: [id])
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  createdAt DateTime @default(now())
  @@unique([userId, postId])
  @@index([postId])
}

model Bookmark {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  createdAt DateTime @default(now())
  @@unique([userId, postId])
  @@index([postId])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  follower    User     @relation("Follower", fields: [followerId], references: [id])
  following   User     @relation("Following", fields: [followingId], references: [id])
  createdAt   DateTime @default(now())
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model FollowRequest {
  id          String   @id @default(uuid())
  requesterId String
  targetId    String
  status      String   @default("pending") // pending, accepted, rejected
  requester   User     @relation("Requester", fields: [requesterId], references: [id])
  target      User     @relation("Target", fields: [targetId], references: [id])
  createdAt   DateTime @default(now())
  @@unique([requesterId, targetId])
  @@index([requesterId])
  @@index([targetId])
}

model CloseFriend {
  id          String   @id @default(uuid())
  userId      String
  friendId    String
  user        User     @relation("UserCloseFriends", fields: [userId], references: [id])
  friend      User     @relation("FriendCloseFriends", fields: [friendId], references: [id])
  createdAt   DateTime @default(now())
  @@unique([userId, friendId])
  @@index([userId])
  @@index([friendId])
}

model Block {
  id          String   @id @default(uuid())
  blockerId   String
  blockedId   String
  blocker     User     @relation("Blocker", fields: [blockerId], references: [id])
  blocked     User     @relation("Blocked", fields: [blockedId], references: [id])
  createdAt   DateTime @default(now())
  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

model Notification {
  id          String   @id @default(uuid())
  userId      String
  actorId     String
  type        String   // mention, like, follow_request, follow, follow_action, unfollow, comment
  postId      String?
  commentId   String?
  message     String?
  isRead      Boolean  @default(false)
  user        User     @relation(fields: [userId], references: [id])
  actor       User     @relation("Actor", fields: [actorId], references: [id])
  post        Post?    @relation(fields: [postId], references: [id])
  comment     Comment? @relation(fields: [commentId], references: [id])
  createdAt   DateTime @default(now())
  @@index([userId])
  @@index([actorId])
  @@index([postId])
  @@index([commentId])
}

model Mention {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Comment {
  id        String       @id @default(uuid())
  content   String
  postId    String
  userId    String
  parentId  String?
  post      Post         @relation(fields: [postId], references: [id])
  user      User         @relation(fields: [userId], references: [id])
  parent    Comment?     @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[]    @relation("CommentReplies")
  likes     CommentLike[]
  likeCount Int          @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  Notification Notification[]
}

model CommentLike {
  id        String   @id @default(uuid())
  userId    String
  commentId String
  user      User     @relation(fields: [userId], references: [id])
  comment   Comment  @relation(fields: [commentId], references: [id])
  createdAt DateTime @default(now())
  @@unique([userId, commentId])
  @@index([commentId])
}

model Hashtag {
  id        String       @id @default(uuid())
  name      String       @unique
  posts     PostHashtag[]
  createdAt DateTime     @default(now())
}

model PostHashtag {
  postId    String
  hashtagId String
  post      Post      @relation(fields: [postId], references: [id])
  hashtag   Hashtag   @relation(fields: [hashtagId], references: [id])
  createdAt DateTime  @default(now())
  @@unique([postId, hashtagId])
}

model VerificationToken {
  id        String   @id @default(uuid())
  userId    String   @unique
  token     String   @unique
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}